<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle Cartoon Race üèéÔ∏èüê±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;700&family=IBM+Plex+Sans+Thai:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['IBM Plex Sans Thai', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        darkBg: '#050510',
                        neonCyan: '#00f2ff',
                        neonOrange: '#ff5a00',
                        glass: 'rgba(255, 255, 255, 0.03)'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050510;
            color: #fff;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(0, 242, 255, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 90, 0, 0.05) 0%, transparent 40%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .track-line {
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.05) 50%, transparent 100%);
            height: 2px;
            width: 100%;
        }

        .player-node {
            transition: all 0.1s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        @keyframes tapEffect {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.2);
                filter: brightness(1.8);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        .tap-active {
            animation: tapEffect 0.1s ease-out;
        }

        .finish-line {
            background: repeating-linear-gradient(45deg,
                    #fff,
                    #fff 10px,
                    #000 10px,
                    #000 20px);
            width: 20px;
            height: 100%;
            position: absolute;
            right: 0;
            opacity: 0.3;
        }

        .avatar-btn {
            transition: all 0.3s ease;
        }

        .avatar-btn.selected {
            border-color: #ff5a00;
            background: rgba(255, 90, 0, 0.2);
            transform: scale(1.1);
        }
    </style>
</head>

<body class="font-sans min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Header -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-12">
        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 rounded-lg bg-neonOrange flex items-center justify-center shadow-[0_0_15px_rgba(255,90,0,0.5)]">
                <i class="fas fa-paw text-white"></i>
            </div>
            <div>
                <h1 class="font-display font-bold text-xl tracking-tighter uppercase">Cartoon Race</h1>
                <p class="text-[10px] text-gray-500 font-mono tracking-widest uppercase">Multiplayer Challenge</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="pb-display"
                class="hidden md:block glass-panel px-3 py-1 rounded-lg text-[10px] text-gray-400 font-mono">
                PERSONAL BEST: <span id="pb-value" class="text-neonCyan">--.---s</span>
            </div>
            <div id="connection-status"
                class="px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20 text-[10px] text-red-400 font-bold uppercase tracking-widest">
                Offline
            </div>
        </div>
    </header>

    <!-- Join Screen -->
    <div id="setup-screen"
        class="w-full max-w-lg glass-panel p-8 rounded-2xl flex flex-col gap-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
        <div class="text-center">
            <h2 class="text-2xl font-display font-bold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ & ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á</h2>
            <p class="text-gray-400 text-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß</p>
        </div>

        <div class="grid grid-cols-5 gap-3 mb-2">
            <button onclick="selectAvatar('üê±')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10 selected"
                data-avatar="üê±">üê±</button>
            <button onclick="selectAvatar('üê∂')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üê∂">üê∂</button>
            <button onclick="selectAvatar('ü¶ä')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="ü¶ä">ü¶ä</button>
            <button onclick="selectAvatar('ü¶Å')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="ü¶Å">ü¶Å</button>
            <button onclick="selectAvatar('üê∞')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üê∞">üê∞</button>
            <button onclick="selectAvatar('üêµ')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üêµ">üêµ</button>
            <button onclick="selectAvatar('üê∏')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üê∏">üê∏</button>
            <button onclick="selectAvatar('üê∑')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üê∑">üê∑</button>
            <button onclick="selectAvatar('üêº')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="üêº">üêº</button>
            <button onclick="selectAvatar('ü§ñ')"
                class="avatar-btn h-14 rounded-xl border border-white/10 bg-white/5 text-2xl hover:bg-white/10"
                data-avatar="ü§ñ">ü§ñ</button>
        </div>

        <div class="flex flex-col gap-4">
            <input type="text" id="player-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ Oracle ‡∏´‡∏£‡∏∑‡∏≠ Nickname..."
                class="bg-white/5 border border-white/10 p-4 rounded-xl text-center text-lg focus:outline-none focus:border-neonOrange transition-all w-full">

            <button onclick="startGame()"
                class="w-full py-4 bg-neonOrange rounded-xl font-bold shadow-[0_0_20px_rgba(255,90,0,0.3)] hover:scale-[1.02] transition-transform text-white">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ô‡∏≤‡∏°‡πÅ‡∏Ç‡πà‡∏á üèéÔ∏è
            </button>
        </div>

        <p class="text-[10px] text-gray-500 text-center italic">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- Race Scene -->
    <div id="race-screen" class="hidden w-full max-w-6xl flex flex-col gap-8">
        <!-- Stadium Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 flex flex-col gap-6">
                <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest"><i
                                class="fas fa-flag-checkered mr-2 text-neonCyan"></i> ‡∏•‡∏π‡πà‡∏ß‡∏¥‡πà‡∏á‡πÅ‡∏ö‡∏ö Real-Time</span>
                        <div class="flex gap-4">
                            <span id="cpm-display"
                                class="text-[10px] text-neonOrange font-bold font-mono px-2 py-1 bg-neonOrange/10 rounded border border-neonOrange/20">CPM:
                                0</span>
                            <span id="timer-display"
                                class="text-[10px] text-white font-mono px-2 py-1 bg-white/5 rounded border border-white/10">TIME:
                                0.00s</span>
                        </div>
                    </div>

                    <!-- Track -->
                    <div id="track-container" class="space-y-12 py-8 min-h-[400px] relative">
                        <div class="finish-line"></div>
                        <!-- Players go here -->
                    </div>

                    <div class="mt-4 pt-4 border-t border-white/5 flex justify-center">
                        <div class="animate-bounce">
                            <span
                                class="px-4 py-2 bg-white/10 rounded-full text-xs font-bold text-neonOrange border border-neonOrange/30">
                                ‚å®Ô∏è ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° SPACE BAR ‡∏£‡∏±‡∏ß‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏±‡∏ß! // turbo
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hall of Fame & Stats -->
            <div class="flex flex-col gap-6">
                <!-- Session Records -->
                <div class="glass-panel p-6 rounded-2xl flex flex-col h-fit">
                    <h3 class="text-xs font-bold text-neonCyan uppercase tracking-widest mb-6"><i
                            class="fas fa-trophy mr-2"></i> Hall of Fame (Newest)</h3>
                    <div id="hof-list" class="flex flex-col gap-4">
                        <div class="text-center py-8 text-gray-600 italic text-xs">Waiting for MQTT stats...</div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-2xl flex flex-col h-fit bg-neonCyan/5 border-neonCyan/20">
                    <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-4"><i
                            class="fas fa-medal mr-2 text-yellow-400"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-400">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (PB)</span>
                        <span id="stats-pb" class="font-bold text-neonCyan">--.---s</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <p class="text-[10px] text-gray-500 italic leading-relaxed">
                            üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÅ‡∏ö‡∏ö‡∏™‡∏∞‡πÄ‡∏õ‡∏∞‡∏™‡∏∞‡∏õ‡∏∞!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Win Overlay -->
    <div id="win-overlay"
        class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-6">
        <div
            class="max-w-md w-full glass-panel p-12 rounded-3xl text-center border-neonOrange bg-neonOrange/5 relative overflow-hidden">
            <div
                class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-neonOrange/20 via-transparent to-transparent">
            </div>
            <div id="win-avatar" class="text-8xl mb-6 relative z-10 animate-bounce">üèÜ</div>
            <h2 class="text-4xl font-display font-bold mb-2 relative z-10">FINISHED!</h2>
            <div class="flex justify-center gap-6 mb-8 relative z-10">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase">Your Time</p>
                    <p id="win-time" class="text-2xl font-display font-bold text-neonCyan">0.000s</p>
                </div>
                <div id="new-pb-badge" class="hidden">
                    <p class="text-[10px] text-neonOrange uppercase font-bold">New PB!</p>
                    <p class="text-2xl font-display font-bold text-white">üî•</p>
                </div>
            </div>
            <button onclick="resetGame()"
                class="relative z-10 w-full py-4 bg-neonOrange rounded-xl font-bold shadow-[0_0_30px_rgba(255,90,0,0.5)] hover:scale-105 active:scale-95 transition-all text-white">
                ‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ üèéÔ∏è
            </button>
        </div>
    </div>

    <!-- Background Decoration -->
    <div
        class="fixed bottom-0 left-0 w-full p-6 text-[10px] text-gray-800 font-mono tracking-widest text-center pointer-events-none uppercase">
        Oracle Racing Engine v2.0 ‚Ä¢ Interactive Game Experience
    </div>

    <script>
        // --- Constants & Global State ---
        const BROKER = 'wss://broker.emqx.io:8083/mqtt';
        const BASE_TOPIC = 'oracle/race/v2'; // Bumped version for new schema

        let client = null;
        let myId = 'player_' + Math.random().toString(16).slice(2, 8);
        let myName = '';
        let myAvatar = 'üê±';
        let myColor = '#ff5a00';

        let progress = 0;
        let isStarted = false;
        let isWinner = false;
        let remotePlayers = {};

        // Stats
        let startTime = 0;
        let finishTime = 0;
        let lastTapTimes = [];
        let personalBest = localStorage.getItem('race_pb') ? parseFloat(localStorage.getItem('race_pb')) : Infinity;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (personalBest !== Infinity) {
                document.getElementById('pb-value').innerText = personalBest.toFixed(3) + 's';
                document.getElementById('stats-pb').innerText = personalBest.toFixed(3) + 's';
                document.getElementById('pb-display').classList.remove('hidden');
            }
        });

        function selectAvatar(emoji) {
            myAvatar = emoji;
            document.querySelectorAll('.avatar-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.avatar === emoji);
            });
            // Assign a color based on avatar for legacy support/variety (optional)
            const colors = ['#ff5a00', '#00f2ff', '#ff0088', '#aaff00', '#ffffff', '#ffff00', '#ff00ff', '#00ff00', '#7700ff', '#ffaa00'];
            const idx = Array.from(document.querySelectorAll('.avatar-btn')).findIndex(b => b.dataset.avatar === emoji);
            myColor = colors[idx % colors.length];
        }

        function initMQTT() {
            client = mqtt.connect(BROKER, {
                clientId: myId,
                clean: true,
                will: {
                    topic: `${BASE_TOPIC}/leave/${myId}`,
                    payload: JSON.stringify({ id: myId }),
                    qos: 0,
                    retain: false
                }
            });

            const connStatus = document.getElementById('connection-status');
            client.on('connect', () => {
                connStatus.innerText = 'Online';
                connStatus.className = 'px-3 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-[10px] text-green-400 font-bold uppercase tracking-widest';
                client.subscribe(`${BASE_TOPIC}/state/+`);
                client.subscribe(`${BASE_TOPIC}/leave/+`);
                client.subscribe(`${BASE_TOPIC}/hof`);
            });

            client.on('message', (topic, payload) => {
                try {
                    const data = JSON.parse(payload.toString());
                    if (topic === `${BASE_TOPIC}/hof`) {
                        updateHOF(data);
                    } else if (topic.startsWith(`${BASE_TOPIC}/state/`)) {
                        if (data.id !== myId) {
                            remotePlayers[data.id] = data;
                            updateTrackUI();
                        }
                    } else if (topic.startsWith(`${BASE_TOPIC}/leave/`)) {
                        delete remotePlayers[data.id];
                        updateTrackUI();
                    }
                } catch (e) {
                    console.error("MQTT Parse Error", e);
                }
            });
        }

        function startGame() {
            const nameInput = document.getElementById('player-name');
            if (!nameInput.value.trim()) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏±‡∏ö!');
                return;
            }

            myName = nameInput.value;
            isStarted = true;
            startTime = Date.now();

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('race-screen').classList.remove('hidden');

            initMQTT();
            updateTrackUI();

            // Sync & UI Loops
            setInterval(publishState, 200);
            setInterval(updateGameStats, 100);

            // Cleanup inactive players
            setInterval(() => {
                const now = Date.now();
                Object.keys(remotePlayers).forEach(id => {
                    if (now - remotePlayers[id].ts > 5000) {
                        delete remotePlayers[id];
                        updateTrackUI();
                    }
                });
            }, 2000);
        }

        // --- Logic Updates ---
        function publishState() {
            if (!client || !isStarted) return;
            client.publish(`${BASE_TOPIC}/state/${myId}`, JSON.stringify({
                id: myId,
                name: myName,
                avatar: myAvatar,
                color: myColor,
                progress: progress,
                ts: Date.now()
            }));
        }

        function updateGameStats() {
            if (!isStarted || isWinner) return;

            // Timer
            const elapsed = (Date.now() - startTime) / 1000;
            document.getElementById('timer-display').innerText = `TIME: ${elapsed.toFixed(2)}s`;

            // CPM (Clicks Per Minute)
            const now = Date.now();
            lastTapTimes = lastTapTimes.filter(t => now - t < 10000); // Only keep last 10s
            const cpm = Math.round((lastTapTimes.length / 10) * 60);
            document.getElementById('cpm-display').innerText = `CPM: ${cpm}`;
        }

        function announceWinner() {
            if (isWinner) return;
            isWinner = true;
            finishTime = (Date.now() - startTime) / 1000;

            // Check PB
            let isNewPb = false;
            if (finishTime < personalBest) {
                personalBest = finishTime;
                localStorage.setItem('race_pb', personalBest);
                document.getElementById('pb-value').innerText = personalBest.toFixed(3) + 's';
                document.getElementById('stats-pb').innerText = personalBest.toFixed(3) + 's';
                isNewPb = true;
            }

            // Publish HOF
            client.publish(`${BASE_TOPIC}/hof`, JSON.stringify({
                name: myName,
                avatar: myAvatar,
                time: finishTime,
                ts: Date.now()
            }), { retain: true, qos: 1 });

            // Winner UI
            document.getElementById('win-time').innerText = finishTime.toFixed(3) + 's';
            document.getElementById('win-avatar').innerText = myAvatar;
            document.getElementById('new-pb-badge').classList.toggle('hidden', !isNewPb);
            document.getElementById('win-overlay').classList.remove('hidden');
        }

        function updateTrackUI() {
            const track = document.getElementById('track-container');
            const allPlayers = [
                { id: myId, name: myName, avatar: myAvatar, color: myColor, progress: progress, isMe: true },
                ...Object.values(remotePlayers)
            ];

            track.innerHTML = '<div class="finish-line"></div>';
            allPlayers.forEach(p => {
                const lane = document.createElement('div');
                lane.className = 'w-full relative h-4 bg-white/5 rounded-full mb-12';
                lane.innerHTML = `
                    <div class="absolute -top-7 left-0 text-[10px] font-bold ${p.isMe ? 'text-neonOrange' : 'text-gray-500'} flex items-center gap-2">
                        <span class="bg-white/10 px-2 py-0.5 rounded border border-white/5">${p.name}</span>
                        ${p.isMe ? '<span class="text-neonCyan animate-pulse">YOU</span>' : ''}
                    </div>
                    <div class="track-line absolute top-1/2 -translate-y-1/2"></div>
                    <div class="player-node absolute top-1/2 -translate-y-1/2 -ml-6" style="left: ${p.progress}%">
                        <div class="w-12 h-12 flex items-center justify-center text-3xl drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] transition-transform duration-75">
                            ${p.avatar}
                        </div>
                        <div class="absolute -bottom-8 left-1/2 -translate-x-1/2 font-mono text-[9px] text-gray-500">${p.progress.toFixed(1)}%</div>
                    </div>
                `;
                track.appendChild(lane);
            });
        }

        function updateHOF(data) {
            const list = document.getElementById('hof-list');
            const dateStr = new Date(data.ts).toLocaleTimeString('th-TH');
            list.innerHTML = `
                <div class="glass-panel p-5 rounded-xl border-neonCyan/20 flex items-center gap-4 group hover:border-neonCyan/50 transition-colors">
                    <div class="text-4xl group-hover:scale-110 transition-transform">${data.avatar || 'üëë'}</div>
                    <div class="flex-1">
                        <div class="text-[10px] text-neonCyan font-bold uppercase tracking-widest">Global Record Holder</div>
                        <div class="text-lg font-display font-bold text-white">${data.name}</div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-[10px] text-white/40 font-mono">${dateStr}</span>
                            <span class="text-xs font-bold text-neonOrange">${data.time.toFixed(3)}s</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function resetGame() {
            progress = 0;
            isWinner = false;
            startTime = Date.now();
            lastTapTimes = [];
            document.getElementById('win-overlay').classList.add('hidden');
            updateTrackUI();
        }

        // --- Controller ---
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && isStarted && !isWinner) {
                e.preventDefault();
                progress += 1.25;
                if (progress >= 100) {
                    progress = 100;
                    announceWinner();
                }

                lastTapTimes.push(Date.now());
                updateTrackUI();

                const meNode = document.querySelector('.player-node');
                if (meNode) {
                    meNode.classList.add('tap-active');
                    setTimeout(() => meNode.classList.remove('tap-active'), 100);
                }
            }
        });

    </script>
</body>

</html>