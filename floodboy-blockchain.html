<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodBoy Blockchain Viewer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkPanel: '#0F1015',
                        darkBg: '#050608',
                        neonBlue: '#3B82F6',
                        neonGreen: '#10B981',
                        neonCyan: '#06b6d4'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icon set -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top center, #1a1e2d 0%, #050608 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(15, 16, 21, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glow-text-blue {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .glow-text-green {
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(5, 6, 8, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #050608;
        }

        ::-webkit-scrollbar-thumb {
            background: #1f2937;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #374151;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .stat-label {
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #6b7280;
        }

        /* Table styles */
        .premium-table th {
            text-transform: uppercase;
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #6b7280;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .premium-table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .premium-table tr:last-child td {
            border-bottom: none;
        }

        .metric-name {
            font-weight: 600;
            color: #f3f4f6;
            font-size: 0.85rem;
        }

        .metric-val {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: #e2e8f0;
        }
    </style>
</head>

<body class="p-4 md:p-8 flex flex-col items-center">

    <div id="app" class="w-full max-w-5xl space-y-6">

        <!-- Top Header Title Area -->
        <div class="text-center mb-10 mt-4">
            <div
                class="inline-block px-3 py-1 rounded-full bg-blue-900/30 border border-blue-500/30 text-neonBlue text-xs font-bold tracking-wider uppercase mb-4 shadow-[0_0_15px_rgba(59,130,246,0.2)]">
                JIBCHAIN L1 â€¢ CHAIN ID 8899
            </div>
            <h1 id="store-nickname" class="text-4xl md:text-5xl font-extrabold text-white tracking-tight mb-2">
                Loading...</h1>
            <p id="store-desc" class="text-gray-400 text-sm md:text-base font-light">Connecting to blockchain network...
            </p>
            <p class="text-gray-500 text-xs mt-1 font-mono italic">loc: 18.77247, 98.99015</p>

            <div class="flex justify-center items-center gap-8 mt-6">
                <div class="text-center">
                    <div class="stat-label mb-1">Current Block</div>
                    <div id="current-block" class="stat-value text-neonGreen glow-text-green">-------</div>
                </div>
                <div class="text-center">
                    <div class="stat-label mb-1">Last Updated</div>
                    <div id="last-updated" class="stat-value text-neonGreen glow-text-green">--:--:--</div>
                </div>
            </div>
        </div>

        <!-- Store Selector (Admin / Demo tools) -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-6">
            <div class="flex gap-2">
                <button onclick="switchStore('0xCd3Ec17ddFDa24f8F97131fa0FDf20e7cbd1A8Bb')"
                    class="px-4 py-1.5 glass-panel hover:bg-white/5 text-xs text-gray-300 transition-all focus:outline-none focus:ring-1 focus:ring-blue-500/50">FloodBoy001</button>
                <button onclick="switchStore('0x0994Bc66b2863f8D58C8185b1ed6147895632812')"
                    class="px-4 py-1.5 glass-panel hover:bg-white/5 text-xs text-gray-300 transition-all focus:outline-none focus:ring-1 focus:ring-blue-500/50 border-blue-500/30 text-white">FloodBoy016</button>
            </div>

            <div class="h-6 w-px bg-white/10 hidden md:block"></div>

            <!-- View Controls -->
            <div class="flex bg-darkBg p-1 rounded border border-white/5">
                <button id="view-chart-btn" onclick="toggleView('chart')"
                    class="px-3 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all">
                    <i class="fas fa-chart-line mr-1"></i> Chart
                </button>
                <button id="view-table-btn" onclick="toggleView('table')"
                    class="px-3 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all">
                    <i class="fas fa-table-list mr-1"></i> Table
                </button>
            </div>
        </div>

        <!-- Main Chart Section (Full Width Top) -->
        <section id="chart-section" class="glass-panel p-6 relative">
            <div id="loading-chart" class="loading-overlay hidden">
                <div class="spinner"></div>
            </div>

            <div class="flex flex-col lg:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-darkBg flex items-center justify-center border border-white/5">
                        <i class="fas fa-chart-line text-neonBlue text-sm"></i>
                    </div>
                    <h3 id="chart-title" class="text-lg font-bold text-white tracking-wide">Water Depth Over Time</h3>
                </div>

                <div class="flex flex-wrap justify-center gap-3">
                    <!-- Metric Toggle -->
                    <div class="flex bg-darkBg p-1 rounded border border-white/5">
                        <button id="toggle-water" onclick="toggleChart('waterDepth')"
                            class="px-3 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all">Water
                            Depth</button>
                        <button id="toggle-battery" onclick="toggleChart('batteryVoltage')"
                            class="px-3 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all">Battery
                            Voltage</button>
                    </div>

                    <!-- Grouping Toggle -->
                    <div class="flex bg-darkBg p-1 rounded border border-white/5">
                        <button onclick="setGrouping(30, this)"
                            class="group-btn px-2 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all">30m</button>
                        <button onclick="setGrouping(60, this)"
                            class="group-btn px-2 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all">1h</button>
                        <button onclick="setGrouping(360, this)"
                            class="group-btn px-2 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all">6h</button>
                        <button onclick="setGrouping(1440, this)"
                            class="group-btn px-2 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all">24h</button>
                    </div>

                    <!-- Fullscreen -->
                    <button onclick="toggleFullscreen()"
                        class="w-8 h-8 flex items-center justify-center bg-darkBg text-gray-400 hover:text-white rounded border border-white/5 transition-all">
                        <i class="fas fa-expand text-xs"></i>
                    </button>
                </div>
            </div>

            <div id="chart-container" class="w-full h-[350px] transition-all duration-300">
                <canvas id="sensorChart"></canvas>
                <div id="no-data-msg"
                    class="hidden h-full flex items-center justify-center text-gray-600 italic font-mono text-sm">No
                    historical data available</div>
            </div>
        </section>

        <div id="bottom-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-20">

            <!-- Left: Data Table -->
            <section id="table-section" class="glass-panel p-6 relative overflow-hidden">
                <div id="loading-table" class="loading-overlay hidden">
                    <div class="spinner"></div>
                </div>

                <div class="flex items-center gap-3 mb-6">
                    <div class="w-8 h-8 rounded bg-darkBg flex items-center justify-center border border-white/5">
                        <i class="fas fa-table-list text-neonBlue text-sm"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white tracking-wide">Latest Sensor Data</h3>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left premium-table">
                        <thead>
                            <tr>
                                <th class="p-2 pl-0">Metric</th>
                                <th class="p-2">Current</th>
                                <th class="p-2">Min</th>
                                <th class="p-2 pr-0">Max</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Data rows injected by JS -->
                            <tr>
                                <td colspan="4" class="py-6 text-center text-gray-600 font-mono text-sm">Loading
                                    telemetry...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Right: Store Metadata -->
            <section class="glass-panel p-6 relative">
                <div id="loading-meta" class="loading-overlay hidden">
                    <div class="spinner"></div>
                </div>

                <div class="flex items-center gap-3 mb-6 justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-darkBg flex items-center justify-center border border-white/5">
                            <i class="fas fa-fingerprint text-gray-400 text-sm"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white tracking-wide">Store Metadata</h3>
                    </div>
                </div>

                <div class="space-y-5 mt-2">
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <span class="text-xs text-gray-500 font-medium tracking-wider uppercase">Store Address</span>
                        <a id="store-link" href="#" target="_blank"
                            class="font-mono text-sm text-neonBlue hover:text-blue-400 transition-colors flex items-center gap-2">
                            <span id="store-address">0x...</span>
                        </a>
                    </div>
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <span class="text-xs text-gray-500 font-medium tracking-wider uppercase">Owner Address</span>
                        <a id="owner-link" href="#" target="_blank"
                            class="font-mono text-sm text-neonBlue hover:text-blue-400 transition-colors">
                            <span id="store-owner">0x...</span>
                        </a>
                    </div>
                    <div class="flex justify-between items-center border-b border-white/5 pb-4">
                        <span class="text-xs text-gray-500 font-medium tracking-wider uppercase">Deployed Block</span>
                        <a id="deployed-block" href="#" target="_blank"
                            class="font-mono text-sm text-gray-300 hover:text-white transition-colors">
                            #...
                        </a>
                    </div>
                    <div class="flex justify-between items-center pb-2">
                        <span class="text-xs text-gray-500 font-medium tracking-wider uppercase">Authorized
                            Sensors</span>
                        <span id="sensor-count" class="font-mono text-sm text-gray-200">...</span>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { createPublicClient, http } from 'https://esm.sh/viem@2.9.11';

        // ABIs
        const FactoryABI = [
            {
                "name": "getStoreInfo", "inputs": [{ "name": "store", "type": "address" }], "outputs": [
                    { "name": "nickname", "type": "string" },
                    { "name": "owner", "type": "address" },
                    { "name": "authorizedSensorCount", "type": "uint256" },
                    { "name": "deployedBlock", "type": "uint128" },
                    { "name": "description", "type": "string" }
                ], "stateMutability": "view", "type": "function"
            }
        ];

        const StoreABI = [
            {
                "name": "getAllFields", "outputs": [{
                    "components": [
                        { "name": "name", "type": "string" },
                        { "name": "unit", "type": "string" },
                        { "name": "dtype", "type": "string" }
                    ], "type": "tuple[]"
                }], "stateMutability": "view", "type": "function"
            },
            {
                "name": "getLatestRecord", "inputs": [{ "name": "sensor", "type": "address" }], "outputs": [
                    { "name": "", "type": "uint256" },
                    { "name": "", "type": "int256[]" }
                ], "stateMutability": "view", "type": "function"
            },
            {
                "anonymous": false, "inputs": [
                    { "indexed": true, "name": "sensor", "type": "address" },
                    { "indexed": false, "name": "timestamp", "type": "uint256" },
                    { "indexed": false, "name": "values", "type": "int256[]" }
                ], "name": "RecordStored", "type": "event"
            }
        ];

        // JIBCHAIN Setup
        const jibchain = {
            id: 8899,
            name: 'JIBCHAIN L1',
            rpcUrls: { default: { http: ['https://rpc-l1.jibchain.net'] } }
        };

        const client = createPublicClient({ chain: jibchain, transport: http() });

        // Constants
        const FACTORY_ADDRESS = '0x63bB41b79b5aAc6e98C7b35Dcb0fE941b85Ba5Bb';
        const UNIVERSAL_SIGNER = '0xcB0e58b011924e049ce4b4D62298Edf43dFF0BDd';

        // App State
        let currentStore = '0x0994Bc66b2863f8D58C8185b1ed6147895632812'; // Default: FloodBoy016
        let chartInstance = null;
        let globalHistoricalData = [];
        let groupedHistoricalData = [];
        let currentFields = [];
        let activeChartType = 'waterDepth';
        let groupingInterval = 30; // 30 minutes default

        Chart.defaults.color = '#6b7280';
        Chart.defaults.font.family = "'JetBrains Mono', monospace";

        const toggleLoader = (id, show) => {
            const el = document.getElementById(id);
            if (el) { if (show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
        };

        const truncateAddress = (addr) => `${addr.substring(0, 6)}...${addr.substring(addr.length - 4)}`;

        const formatTimeOnly = (ts) => {
            const d = new Date(Number(ts));
            return d.toLocaleTimeString('en-US', { hour12: false });
        };

        function formatFieldName(fieldName) {
            return fieldName.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        }

        function processValue(value, unit) {
            if (value === null || value === undefined) return '-';
            const baseUnit = unit.replace(/ x\\d+/, '');
            if (unit.includes('x10000')) return (Number(value) / 10000).toFixed(4) + ' ' + baseUnit;
            if (unit.includes('x1000')) return (Number(value) / 1000).toFixed(3) + ' ' + baseUnit;
            if (unit.includes('x100')) return (Number(value) / 100).toFixed(3) + ' ' + baseUnit;
            return value + ' ' + baseUnit;
        }

        // Data Grouping Algorithm
        function groupData(data, intervalMinutes) {
            if (!data || data.length === 0) return [];
            const intervalMs = intervalMinutes * 60 * 1000;
            const grouped = [];
            let currentGroup = [];
            let currentIntervalStart = Math.floor(data[0].timestamp / intervalMs) * intervalMs;

            data.forEach(item => {
                if (item.timestamp >= currentIntervalStart + intervalMs) {
                    if (currentGroup.length > 0) {
                        grouped.push(averageGroup(currentGroup, currentIntervalStart));
                        currentGroup = [];
                    }
                    currentIntervalStart = Math.floor(item.timestamp / intervalMs) * intervalMs;
                }
                currentGroup.push(item);
            });
            if (currentGroup.length > 0) {
                grouped.push(averageGroup(currentGroup, currentIntervalStart));
            }
            return grouped;
        }

        function averageGroup(group, timestamp) {
            const avg = { timestamp: timestamp, waterDepth: null, batteryVoltage: null, rawValues: group[group.length - 1].rawValues };
            let wdSum = 0, wdCount = 0, bvSum = 0, bvCount = 0;

            group.forEach(item => {
                if (item.waterDepth !== null) { wdSum += item.waterDepth; wdCount++; }
                if (item.batteryVoltage !== null) { bvSum += item.batteryVoltage; bvCount++; }
            });

            if (wdCount > 0) avg.waterDepth = wdSum / wdCount;
            if (bvCount > 0) avg.batteryVoltage = bvSum / bvCount;
            return avg;
        }

        // Chart.js implementation for dark mode
        function renderChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const noDataMsg = document.getElementById('no-data-msg');

            groupedHistoricalData = groupData(globalHistoricalData, groupingInterval);

            if (chartInstance) chartInstance.destroy();

            if (groupedHistoricalData.length === 0) {
                document.getElementById('sensorChart').style.display = 'none';
                noDataMsg.classList.remove('hidden');
                return;
            }

            document.getElementById('sensorChart').style.display = 'block';
            noDataMsg.classList.add('hidden');

            const isWater = activeChartType === 'waterDepth';
            const hexColor = isWater ? '#3B82F6' : '#10B981';
            const rgbColor = isWater ? '59,130,246' : '16,185,129';

            const bgGradient = ctx.createLinearGradient(0, 0, 0, 350);
            bgGradient.addColorStop(0, `rgba(${rgbColor}, 0.3)`);
            bgGradient.addColorStop(1, 'rgba(5, 6, 8, 0)');

            const dataPoints = groupedHistoricalData.map(d => ({
                x: new Date(d.timestamp),
                y: isWater ? d.waterDepth : d.batteryVoltage
            })).filter(d => d.y !== null);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: isWater ? 'Water Depth (m)' : 'Battery Voltage (V)',
                        data: dataPoints,
                        borderColor: hexColor,
                        backgroundColor: bgGradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHitRadius: 15,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: hexColor,
                        pointHoverBorderWidth: 2,
                        fill: true,
                        tension: 0.3 // Smooth curves
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 16, 21, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: hexColor,
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    let val = isWater ? context.parsed.y.toFixed(4) : context.parsed.y.toFixed(3);
                                    return `${val} ${isWater ? 'm' : 'V'}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: { hour: 'ha' }
                            },
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                            ticks: { font: { size: 10 }, maxRotation: 45 }
                        },
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                            ticks: { font: { size: 10 }, padding: 10 }
                        }
                    }
                }
            });
        }

        window.toggleChart = function (type) {
            activeChartType = type;
            const btnW = document.getElementById('toggle-water');
            const btnB = document.getElementById('toggle-battery');
            const title = document.getElementById('chart-title');
            const icon = document.querySelector('.fa-chart-line');

            if (type === 'waterDepth') {
                btnW.className = "px-4 py-1.5 bg-white/10 text-white rounded text-xs font-semibold transition-all";
                btnB.className = "px-4 py-1.5 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all";
                title.innerText = "Water Depth Over Time";
                icon.className = "fas fa-chart-line text-neonBlue text-sm";
            } else {
                btnB.className = "px-4 py-1.5 bg-white/10 text-white rounded text-xs font-semibold transition-all";
                btnW.className = "px-4 py-1.5 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all";
                title.innerText = "Battery Voltage Over Time";
                icon.className = "fas fa-bolt text-neonGreen text-sm";
            }

            renderChart();
        };

        function calculateAggregates(valuesIndex) {
            let min = null, max = null;
            let validValues = globalHistoricalData.map(ev => {
                return ev.rawValues ? Number(ev.rawValues[valuesIndex]) : null;
            }).filter(v => v !== null && !isNaN(v));

            if (validValues.length > 0) {
                min = Math.min(...validValues);
                max = Math.max(...validValues);
            }
            return { min, max, count: validValues.length };
        }

        async function loadData() {
            ['loading-meta', 'loading-chart', 'loading-table'].forEach(id => toggleLoader(id, true));

            try {
                // 1. Get Block Number
                const blockNumber = await client.getBlockNumber();
                document.getElementById('current-block').innerText = blockNumber.toString();

                // 2. Get Store Info from Factory
                const factoryResult = await client.readContract({
                    address: FACTORY_ADDRESS, abi: FactoryABI, functionName: 'getStoreInfo', args: [currentStore]
                });

                const nickname = factoryResult[0];
                const owner = factoryResult[1];
                const sensorCount = factoryResult[2];
                const deployedBlock = factoryResult[3];
                const description = factoryResult[4];

                // Metadata UI updates
                document.getElementById('store-nickname').innerText = nickname;
                document.getElementById('store-desc').innerText = description;
                document.getElementById('store-address').innerText = truncateAddress(currentStore);
                document.getElementById('store-link').href = `https://exp.jibchain.net/address/${currentStore}`;

                document.getElementById('store-owner').innerText = truncateAddress(owner);
                document.getElementById('owner-link').href = `https://exp.jibchain.net/address/${owner}`;
                document.getElementById('deployed-block').innerText = `#${deployedBlock}`;
                document.getElementById('deployed-block').href = `https://exp.jibchain.net/block/${deployedBlock}`;
                document.getElementById('sensor-count').innerText = sensorCount.toString();

                toggleLoader('loading-meta', false);

                // 3. Get Subfield Definitions
                currentFields = await client.readContract({
                    address: currentStore, abi: StoreABI, functionName: 'getAllFields'
                });

                // 4. Fetch Historical logs
                const fromBlock = blockNumber > 28800n ? blockNumber - 28800n : 0n;
                const historicalEvents = await client.getContractEvents({
                    address: currentStore, abi: StoreABI, eventName: 'RecordStored',
                    fromBlock, toBlock: 'latest', args: { sensor: UNIVERSAL_SIGNER }
                });

                // Find Indexes
                const wDepthIdx = currentFields.findIndex(f => f.name.toLowerCase().includes('water_depth') && !f.name.includes('min') && !f.name.includes('max'));
                const bVoltIdx = currentFields.findIndex(f => f.name.toLowerCase().includes('battery_voltage') && !f.name.includes('min') && !f.name.includes('max'));

                globalHistoricalData = historicalEvents.map(event => ({
                    timestamp: Number(event.args.timestamp) * 1000,
                    waterDepth: wDepthIdx >= 0 ? Number(event.args.values[wDepthIdx]) / 10000 : null,
                    batteryVoltage: bVoltIdx >= 0 ? Number(event.args.values[bVoltIdx]) / 100 : null,
                    rawValues: event.args.values
                })).sort((a, b) => a.timestamp - b.timestamp);

                renderChart();
                toggleLoader('loading-chart', false);

                // 5. Get Latest Sensor Data to populate the table base
                const latestRes = await client.readContract({
                    address: currentStore, abi: StoreABI, functionName: 'getLatestRecord', args: [UNIVERSAL_SIGNER]
                });

                const currentTimestamp = formatTimeOnly(Number(latestRes[0]) * 1000);
                document.getElementById('last-updated').innerText = currentTimestamp;

                const currentValues = latestRes[1];

                // Build Table
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = '';

                currentFields.forEach((field, index) => {
                    if (field.name.toLowerCase().includes('min') || field.name.toLowerCase().includes('max')) return;
                    if (field.name.toLowerCase().includes('count')) return;

                    const rawVal = currentValues[index];
                    const aggs = calculateAggregates(index);

                    const displayMin = aggs.min !== null ? processValue(aggs.min, field.unit) : '-';
                    const displayMax = aggs.max !== null ? processValue(aggs.max, field.unit) : '-';
                    const currentFormatted = processValue(rawVal, field.unit);

                    let displayName = formatFieldName(field.name);

                    let sampleBadge = '';
                    if (field.name.toLowerCase().includes('water_depth') && aggs.count > 0) {
                        sampleBadge = `<div class="text-[0.6rem] text-gray-500 mt-0.5">${aggs.count} samples</div>`;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="p-2 pl-0 align-top">
                        <div class="metric-name">${displayName}</div>
                        ${sampleBadge}
                    </td>
                    <td class="p-2 align-top"><div class="metric-val">${currentFormatted}</div></td>
                    <td class="p-2 align-top"><div class="metric-val text-gray-400">${displayMin}</div></td>
                    <td class="p-2 pr-0 align-top"><div class="metric-val text-gray-400">${displayMax}</div></td>
                `;
                    tbody.appendChild(row);
                });

                toggleLoader('loading-table', false);

            } catch (error) {
                console.error(error);
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 font-mono text-sm">SYS_ERR: ${error.message}</td></tr>`;
                ['loading-meta', 'loading-chart', 'loading-table'].forEach(id => toggleLoader(id, false));
            }
        }

        window.switchStore = (address) => {
            currentStore = address;
            loadData();
        };

        window.setGrouping = function (minutes, btnElement) {
            groupingInterval = minutes;
            document.querySelectorAll('.group-btn').forEach(btn => {
                btn.className = "group-btn px-2 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all";
            });
            btnElement.className = "group-btn px-2 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all";
            renderChart();
        };

        window.toggleView = function (view) {
            const chartSec = document.getElementById('chart-section');
            const bottomGrid = document.getElementById('bottom-grid');
            const cBtn = document.getElementById('view-chart-btn');
            const tBtn = document.getElementById('view-table-btn');

            if (view === 'chart') {
                chartSec.style.display = 'block';
                bottomGrid.style.display = 'none';
                cBtn.className = "px-3 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all";
                tBtn.className = "px-3 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all";
            } else {
                chartSec.style.display = 'none';
                bottomGrid.style.display = 'grid';
                tBtn.className = "px-3 py-1 bg-white/10 text-white rounded text-xs font-semibold transition-all";
                cBtn.className = "px-3 py-1 text-gray-500 hover:text-gray-300 rounded text-xs font-semibold transition-all";
            }
        };

        window.toggleFullscreen = function () {
            const chartSec = document.getElementById('chart-section');
            if (!document.fullscreenElement) {
                chartSec.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        };

        // Load setup
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js';
        script.onload = () => {
            loadData();
        };
        document.head.appendChild(script);

    </script>
</body>

</html>